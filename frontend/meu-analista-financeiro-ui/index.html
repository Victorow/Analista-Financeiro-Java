<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meu Analista Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#111827',
                        'accent': '#3b82f6',
                        'light': '#f3f4f6',
                        'dark-text': '#d1d5db',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
            color: #d1d5db;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="root"></div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        const COLORS = ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
        const API_BASE_URL = 'http://localhost:8080/api/transacoes';

        // --- Componentes SVG para Ícones ---
        const UploadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 h-5 w-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>
        );
        const PieChartIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 h-5 w-5"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
        );
        const BarChartIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 h-5 w-5"><line x1="12" x2="12" y1="20" y2="10" /><line x1="18" x2="18" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="16" /></svg>
        );

        // --- Componente principal da Aplicação ---
        const App = () => {
            const [data, setData] = useState(null);
            const [resumoFinanceiro, setResumoFinanceiro] = useState(null);
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [activeView, setActiveView] = useState('graficos');
            const [chartType, setChartType] = useState('pizza');
            const fileInputRef = useRef(null);
            const chartContainerRef = useRef(null);

            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setIsLoading(true);
                setError('');
                setData(null);
                setResumoFinanceiro(null);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const uploadResponse = await fetch(`${API_BASE_URL}/upload`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!uploadResponse.ok) {
                         throw new Error(`Erro no upload: ${uploadResponse.statusText}`);
                    }

                    // Busca os dados para os gráficos
                    const despesasResponse = await fetch(`${API_BASE_URL}/resumo-despesas`);
                    if (!despesasResponse.ok) throw new Error('Falha ao buscar resumo de despesas.');
                    const despesasData = await despesasResponse.json();
                    
                    if (!despesasData || despesasData.length === 0) {
                        setError("Nenhuma despesa foi encontrada no extrato para exibir nos gráficos.");
                    } else {
                        setData(despesasData);
                    }
                    
                    // Busca o resumo financeiro completo
                    const resumoResponse = await fetch(`${API_BASE_URL}/resumo-financeiro`);
                    if (!resumoResponse.ok) throw new Error('Falha ao buscar resumo financeiro.');
                    const resumoData = await resumoResponse.json();
                    setResumoFinanceiro(resumoData);

                } catch (err) {
                    console.error("Detalhe do erro:", err);
                    setError(err.message || 'Ocorreu um erro ao processar o ficheiro. Verifique se o backend está a correr.');
                } finally {
                    setIsLoading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };
            
            const totalDespesas = data?.reduce((sum, entry) => sum + entry.total, 0) || 0;

            const exportToExcel = () => {
                const ws = XLSX.utils.json_to_sheet(data.map(d => ({ Categoria: d.categoria, Valor: d.total })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Resumo");
                XLSX.writeFile(wb, "resumo_financeiro.xlsx");
            };

            const downloadAsPdf = () => {
                const { jsPDF } = window.jspdf;
                const chartNode = chartContainerRef.current;
                if (chartNode) {
                    html2canvas(chartNode, { backgroundColor: '#111827' }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({
                            orientation: 'landscape',
                            unit: 'px',
                            format: [canvas.width, canvas.height]
                        });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        pdf.save("resumo_grafico.pdf");
                    });
                }
            };

            const renderInitialView = () => (
                <div className="text-center animate-fade-in">
                    <h1 className="text-4xl font-bold mb-2">Meu Analista Financeiro</h1>
                    <p className="text-lg text-dark-text mb-6">Envie o seu extrato bancário em PDF para começar.</p>
                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".pdf" className="hidden" />
                    <button
                        onClick={() => fileInputRef.current.click()}
                        className="bg-primary hover:bg-accent text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 inline-flex items-center shadow-lg"
                    >
                        <UploadIcon />
                        Selecionar Ficheiro
                    </button>
                </div>
            );

            const renderDataView = () => (
                <div className="w-full max-w-7xl mx-auto p-4 md:p-8 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">Análise Financeira</h2>
                        <div className="flex gap-2">
                             <button onClick={exportToExcel} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Exportar Excel</button>
                             <button onClick={downloadAsPdf} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Baixar PDF</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 text-center animate-slide-up" style={{ animationDelay: '0.2s' }}>
                        <div className="bg-secondary p-6 rounded-xl shadow-lg"><h3 className="text-lg font-semibold text-green-400">Total de Receitas</h3><p className="text-3xl font-bold">{formatCurrency(resumoFinanceiro?.totalReceitas)}</p></div>
                        <div className="bg-secondary p-6 rounded-xl shadow-lg"><h3 className="text-lg font-semibold text-red-400">Total de Despesas</h3><p className="text-3xl font-bold">{formatCurrency(totalDespesas)}</p></div>
                        <div className="bg-secondary p-6 rounded-xl shadow-lg"><h3 className="text-lg font-semibold text-blue-400">Saldo Final</h3><p className="text-3xl font-bold">{formatCurrency(resumoFinanceiro?.saldo)}</p></div>
                    </div>
                    
                     <div className="bg-secondary p-4 sm:p-6 rounded-xl shadow-lg animate-slide-up" style={{ animationDelay: '0.4s' }}>
                        <div className="flex border-b border-gray-700 mb-4">
                            <button onClick={() => setActiveView('graficos')} className={`py-2 px-4 font-semibold ${activeView === 'graficos' ? 'border-b-2 border-primary text-white' : 'text-gray-400'}`}>Gráficos</button>
                            <button onClick={() => setActiveView('tabela')} className={`py-2 px-4 font-semibold ${activeView === 'tabela' ? 'border-b-2 border-primary text-white' : 'text-gray-400'}`}>Tabela</button>
                        </div>

                        {activeView === 'graficos' ? (
                            <div id="chart-container" ref={chartContainerRef}>
                                <div className="flex items-center justify-center mb-4">
                                    <span className="mr-4 font-semibold">Tipo de Gráfico:</span>
                                    <div className="bg-gray-800 p-1 rounded-lg flex gap-1">
                                        <button onClick={() => setChartType('pizza')} className={`px-4 py-1.5 rounded-md text-sm font-semibold transition-colors ${chartType === 'pizza' ? 'bg-primary text-white' : 'text-gray-300 hover:bg-gray-700'}`}>Pizza</button>
                                        <button onClick={() => setChartType('barras')} className={`px-4 py-1.5 rounded-md text-sm font-semibold transition-colors ${chartType === 'barras' ? 'bg-primary text-white' : 'text-gray-300 hover:bg-gray-700'}`}>Barras</button>
                                    </div>
                                </div>
                                <div className="w-full h-[500px]">
                                    {chartType === 'pizza' ? (
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie data={data} cx="50%" cy="50%" labelLine={false} label={({ cx, cy, midAngle, innerRadius, outerRadius, percent }) => {
                                                    const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
                                                    const x = cx + radius * Math.cos(-midAngle * Math.PI / 180);
                                                    const y = cy + radius * Math.sin(-midAngle * Math.PI / 180);
                                                    return percent > 0.05 ? <text x={x} y={y} fill="white" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central">{`${(percent * 100).toFixed(0)}%`}</text> : null;
                                                }} outerRadius="80%" dataKey="total" nameKey="categoria">
                                                    {data.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                                </Pie>
                                                <Tooltip formatter={(value) => formatCurrency(value)} />
                                                <Legend />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    ) : (
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={data} layout="vertical" margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                                                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                                                <XAxis type="number" tickFormatter={formatCurrency} stroke="#9ca3af"/>
                                                <YAxis dataKey="categoria" type="category" width={100} stroke="#9ca3af"/>
                                                <Tooltip formatter={(value) => formatCurrency(value)} cursor={{fill: 'rgba(255,255,255,0.1)'}}/>
                                                <Legend />
                                                <Bar dataKey="total" name="Total Gasto" fill="#3b82f6" />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    )}
                                </div>
                            </div>
                        ) : (
                             <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-800">
                                        <tr>
                                            <th className="p-4">Categoria</th>
                                            <th className="p-4 text-right">Valor Gasto</th>
                                            <th className="p-4 text-right">% do Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.map((item, index) => (
                                            <tr key={index} className="border-b border-gray-700">
                                                <td className="p-4 flex items-center"><span className="h-4 w-4 rounded-full mr-3" style={{ backgroundColor: COLORS[index % COLORS.length] }}></span>{item.categoria}</td>
                                                <td className="p-4 text-right">{formatCurrency(item.total)}</td>
                                                <td className="p-4 text-right">{((item.total / totalDespesas) * 100).toFixed(2)}%</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                </div>
            );

            return (
                <div className="w-screen min-h-screen bg-secondary flex items-center justify-center p-4">
                    {isLoading ? <div className="text-center"><div className="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-primary mx-auto mb-4"></div>A processar...</div> :
                     error ? <div className="text-center text-red-400 max-w-md animate-fade-in"><h2 className="text-2xl font-bold mb-4">Ocorreu um Erro</h2><p>{error}</p></div> :
                     data ? renderDataView() : renderInitialView()}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

